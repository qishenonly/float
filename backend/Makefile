.PHONY: help build run test docker-build docker-build-tar docker-up docker-down docker-logs clean

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

build: ## ç¼–è¯‘é¡¹ç›®
	go build -o bin/server cmd/server/main.go

run: ## è¿è¡Œé¡¹ç›®
	go run cmd/server/main.go

test: ## è¿è¡Œæµ‹è¯•
	go test -v ./...

deps: ## å®‰è£…ä¾èµ–
	go mod download
	go mod tidy

docker-build: ## æ„å»º Docker é•œåƒ
	cd deployments/docker && docker-compose build

docker-build-tar: ## æ„å»º Docker é•œåƒå¹¶æ‰“åŒ…ä¸º tar æ–‡ä»¶ (æ”¯æŒç‰ˆæœ¬å·: make docker-build-tar VERSION=v1.0.0)
	@echo "å¼€å§‹æ„å»ºé•œåƒ..."; \
	cd deployments/docker && docker-compose build; \
	echo "é•œåƒæ„å»ºå®Œæˆï¼Œå¼€å§‹æ‰“åŒ…..."; \
	VERSION=$${VERSION:-latest}; \
	LATEST_IMAGE=float-backend-api:latest; \
	TARGET_IMAGE=float-backend-api:$$VERSION; \
	if [ "$$VERSION" != "latest" ]; then \
		echo "æ ‡ç­¾åŒ–é•œåƒ: $$LATEST_IMAGE -> $$TARGET_IMAGE"; \
		docker tag $$LATEST_IMAGE $$TARGET_IMAGE; \
	fi; \
	if docker images --quiet $$TARGET_IMAGE > /dev/null 2>&1; then \
		echo "ğŸ“¦ æ£€æµ‹åˆ°é•œåƒ: $$TARGET_IMAGE"; \
		TAR_FILE=float-backend-api-$$VERSION.tar; \
		docker save -o $$TAR_FILE $$TARGET_IMAGE; \
		echo "âœ“ é•œåƒå·²æ‰“åŒ…ä¸º $$TAR_FILE"; \
		ls -lh $$TAR_FILE; \
	else \
		echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°é•œåƒ $$TARGET_IMAGE"; \
		echo "å¯ç”¨é•œåƒåˆ—è¡¨:"; \
		docker images | grep -E "float|api|backend" || docker images | head -10; \
		exit 1; \
	fi

docker-up: ## å¯åŠ¨ Docker å®¹å™¨
	cd deployments/docker && docker-compose up -d

docker-down: ## åœæ­¢ Docker å®¹å™¨
	cd deployments/docker && docker-compose down

docker-logs: ## æŸ¥çœ‹ Docker æ—¥å¿—
	cd deployments/docker && docker-compose logs -f api

clean: ## æ¸…ç†ç¼–è¯‘æ–‡ä»¶
	rm -rf bin/
	go clean

.DEFAULT_GOAL := help
