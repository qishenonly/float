# Float Backend Docker Compose 配置文件
# 包含 API、MySQL、Redis、MinIO 完整堆栈

services:
  # Float Backend API
  api:
    container_name: float-api
    platform: linux/amd64  # 指定目标平台，与宿主机一致
    build:
      context: ../..
      dockerfile: deployments/docker/Dockerfile
      platforms:
        - linux/amd64  # 构建时指定平台
    image: float-backend-api:latest
    ports:
      - "${API_PORT:-8080}:8080"
    environment:
      # 服务配置
      APP_MODE: ${APP_MODE:-release}
      APP_NAME: "FloatIsland Backend"
      APP_VERSION: "0.0.1"
      
      # 数据库配置
      DATABASE_HOST: mysql
      DATABASE_PORT: ${MYSQL_PORT:-3306}
      DATABASE_USERNAME: ${DB_USERNAME:-float_user}
      DATABASE_PASSWORD: ${DB_PASSWORD:-float_normal@godqi.user}
      DATABASE_DATABASE: ${DB_DATABASE:-floatisland}
      DATABASE_CHARSET: utf8mb4
      DATABASE_MAX_IDLE_CONNS: 10
      DATABASE_MAX_OPEN_CONNS: 100
      DATABASE_CONN_MAX_LIFETIME: 3600
      
      # Redis 配置
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-float_normal@godqi.user}
      REDIS_DB: 0
      REDIS_POOL_SIZE: 10
      
      # JWT 配置
      JWT_SECRET: ${JWT_SECRET:-float_normal@godqi.user}
      JWT_ACCESS_TOKEN_EXPIRE: 900
      JWT_REFRESH_TOKEN_EXPIRE: 604800
      
      # 邮件配置
      EMAIL_ENABLED: ${EMAIL_ENABLED:-false}
      EMAIL_SMTP_HOST: ${EMAIL_SMTP_HOST:-}
      EMAIL_SMTP_PORT: ${EMAIL_SMTP_PORT:-}
      EMAIL_SMTP_USERNAME: ${EMAIL_SMTP_USERNAME:-}
      EMAIL_SMTP_PASSWORD: ${EMAIL_SMTP_PASSWORD:-}
      EMAIL_FROM: ${EMAIL_FROM:-}
      
      # 日志配置
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: json
      LOG_OUTPUT: stdout
    
    volumes:
      # 映射配置文件（可在容器运行时修改）
      - config:/root/config
      # 映射上传文件目录
      - api_uploads:/root/uploads
      # 映射日志目录
      - api_logs:/root/logs
      # 映射数据库备份目录
      - api_backups:/root/backups
    
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    restart: unless-stopped
    networks:
      - float-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MySQL 数据库
  mysql:
    container_name: float-mysql
    image: mysql:8.0
    command: 
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max_connections=1000
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-}
      MYSQL_DATABASE: ${DB_DATABASE:-}
      MYSQL_USER: ${DB_USERNAME:-}
      MYSQL_PASSWORD: ${DB_PASSWORD:-}
    
    volumes:
      # 数据持久化
      - mysql_data:/root/mysql_data
      # 初始化脚本（可选）
      - ./init-scripts:/docker-entrypoint-initdb.d
    
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    
    restart: unless-stopped
    networks:
      - float-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis 缓存
  redis:
    container_name: float-redis
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}
    
    volumes:
      # 数据持久化
      - redis_data:/root/redis_data
    
    ports:
      - "${REDIS_PORT:-6379}:6379"
    
    restart: unless-stopped
    networks:
      - float-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # # MinIO 对象存储
  # minio:
  #   container_name: float-minio
  #   image: minio/minio:latest
  #   command: server /data --console-address ":9001"
  #   environment:
  #     MINIO_ROOT_USER: ${MINIO_USER:-minioadmin}
  #     MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:-minioadmin}
    
  #   volumes:
  #     # 数据持久化
  #     - minio_data:/data
    
  #   ports:
  #     # API 端口
  #     - "${MINIO_API_PORT:-9000}:9000"
  #     # Web Console 端口
  #     - "${MINIO_CONSOLE_PORT:-9001}:9001"
    
  #   restart: unless-stopped
  #   networks:
  #     - float-network
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
  #     interval: 30s
  #     timeout: 20s
  #     retries: 3
  #     start_period: 30s

volumes:
  # API 配置卷
  config:
    driver: local
  
  # MySQL 数据卷
  mysql_data:
    driver: local
  
  # Redis 数据卷
  redis_data:
    driver: local
  
  # MinIO 数据卷
  # minio_data:
  #   driver: local
  
  # API 上传文件卷
  api_uploads:
    driver: local
  
  # API 日志卷
  api_logs:
    driver: local

  # API 备份卷
  api_backups:
    driver: local

networks:
  # 自定义网络，用于服务间通信
  float-network:
    driver: bridge
